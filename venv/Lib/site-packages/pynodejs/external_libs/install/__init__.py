from sys import platform
import pkg_resources
import binarystring
import subprocess
import requests
import distro
import ctypes
import os

# pynodejs: installation python file



# Checking if Admin rights are given...
try:
    is_admin = os.getuid() == 0
except AttributeError:
    is_admin = ctypes.windll.shell32.IsUserAnAdmin() != 0
if (is_admin == False):
    raise Exception('Please run python as Administrator!')

# Checking for internet connection
try:
    requests.get('http://216.58.192.142') # Google's IP address
except:
    raise Exception('Please connect to the internet to install!')



# Installation for all major OS...

if platform == "linux" or platform == "linux2": # linux...

    # OS Support has not been Tested
    # please report if your os has problems

    print("Installing nodejs and npm on you OSX, might take a while: ")
    print("--> INSTALLATION STARTS HERE <--\n\n")

    psxmlgen = subprocess.Popen(['bash'+pkg_resources.resource_filename('pynodejs', 'data/Linux.sh'),
                                 ], cwd=os.getcwd(), shell=True).wait()

    linux_disto = distro.linux_distribution(full_distribution_name=False)[0] # OS Details

    if(type(psxmlgen)!=int):
        raise Exception(f'Please an issue in for your os[{linux_disto}] https://github.com/hidely/pynodejs')

    print("--> INSTALLATION COMPLETES HERE <--\n")


elif platform == "darwin": # OSX...

    # OS Support has not been Tested
    # please report if your os has problems

    print("Installing nodejs and npm on you OSX, might take a while: ")
    print("--> INSTALLATION STARTS HERE <--\n\n")

    # Installs Nodejs and npm from curl.

    psxmlgen = subprocess.Popen(['bash'+pkg_resources.resource_filename('pynodejs', 'data/OSX.sh'),
                                 ], cwd=os.getcwd(), shell=True).wait()

    nodejs_version = subprocess.Popen(['node','-v'], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE).communicate()[0]
    nodejs_version = binarystring.b2s(nodejs_version)
    nodejs_version = nodejs_version[1:nodejs_version.find('\r')]

    print("--> INSTALLATION COMPLETES HERE <--\n\n")


elif platform == "win32": # Windows...

    # OS Support has been Tested

    print("Installing, if nodejs is not installed this installation might take a while: ")
    print("--> INSTALLATION STARTS HERE <--\n\n")

    # Installing Chocolatey, A Command-line Installer for Windows,
    # then Nodejs and npm from it.

    psxmlgen = subprocess.Popen(["C:\\WINDOWS\\system32\\WindowsPowerShell\\v1.0\\powershell.exe",
                                 '-ExecutionPolicy',
                                 'unrestricted',
                                 '-Command',
                                 pkg_resources.resource_filename('pynodejs', 'data\\Win.ps1'),
                                 ], cwd=os.getcwd(), shell=True).wait()

    nodejs_version = subprocess.Popen(['node','-v'], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True).communicate()[0]
    nodejs_version = binarystring.b2s(nodejs_version)
    nodejs_version = nodejs_version[1:nodejs_version.find('\r')]

    print("--> INSTALLATION COMPLETES HERE <--\n\n")
